{% extends "base.html" %}

{% block content %}
<div class="space-y-6 animate-fade-in-down">
    <div class="flex items-center justify-between pt-6 pb-2">
        <a href="/" class="text-slate-400 hover:text-white transition-colors flex items-center gap-2">
            <span>üè†</span> Hub
        </a>
    </div>

    <div class="text-center pb-4">
        <h1 class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-purple-500">
            Registrar Compra
        </h1>
        <p class="text-slate-400 text-sm mt-1">Selecciona el proveedor para iniciar</p>
    </div>

    <!-- Provider Selection Card -->
    <div class="glass p-6 rounded-2xl shadow-xl">
        <label class="block text-sm font-medium text-slate-300 mb-2">üè™ Proveedor</label>

        <!-- Quick Top Providers -->
        <div id="quickProviders" class="grid grid-cols-2 gap-2 mb-4">
            <!-- Injected by JS -->
        </div>

        <div class="relative">
            <input type="text" id="providerSearch"
                class="w-full bg-slate-800 border border-slate-700 rounded-xl px-4 py-3 text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all"
                placeholder="Buscar proveedor..." onkeyup="filterProviders()">

            <div id="providerDropdown"
                class="hidden absolute w-full mt-2 bg-slate-800 border border-slate-700 rounded-xl shadow-2xl z-50 max-h-60 overflow-y-auto">
                <!-- Dropdown items injected here -->
            </div>
        </div>

        <!-- Create New Provider Button -->
        <button onclick="showCreateProvider()"
            class="mt-4 w-full flex items-center justify-center gap-2 py-3 px-4 rounded-xl border border-dashed border-slate-600 text-slate-400 hover:text-white hover:border-slate-400 hover:bg-slate-700/50 transition-all group">
            <span class="text-xl group-hover:scale-110 transition-transform">+</span>
            Crear nuevo proveedor
        </button>
    </div>

    <div class="text-center">
        <button id="nextBtn" disabled onclick="goToNextStep()"
            class="w-full bg-blue-600 hover:bg-blue-500 disabled:opacity-50 disabled:cursor-not-allowed text-white font-semibold py-4 rounded-xl shadow-lg shadow-blue-500/20 transition-all transform hover:scale-[1.02]">
            Continuar üëâ
        </button>
    </div>
</div>

<!-- Modal: Create Provider -->
<div id="createModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50">
    <div class="glass w-full max-w-sm p-6 rounded-2xl border border-slate-700 transform transition-all scale-100">
        <h3 class="text-lg font-bold text-white mb-4">Nuevo Proveedor</h3>

        <input type="text" id="newProviderName"
            class="w-full bg-slate-900/50 border border-slate-600 rounded-lg px-4 py-3 text-white mb-4 focus:ring-2 focus:ring-green-500 outline-none"
            placeholder="Nombre de la empresa...">

        <div class="flex gap-3">
            <button onclick="hideCreateProvider()"
                class="flex-1 py-3 px-4 rounded-lg bg-slate-700 text-slate-300 hover:bg-slate-600 font-medium">
                Cancelar
            </button>
            <button onclick="saveProvider()"
                class="flex-1 py-3 px-4 rounded-lg bg-green-600 text-white hover:bg-green-500 shadow-lg shadow-green-500/20 font-medium">
                Guardar
            </button>
        </div>
    </div>
</div>

<script>
    let providers = [];
    let selectedProvider = null;

    // Load Providers on Start
    async function loadProviders() {
        try {
            // Load All for Search
            const res = await fetch('/api/providers');
            providers = await res.json();

            // Load Top for Quick Access
            const resTop = await fetch('/api/analysis/top-providers');
            const top = await resTop.json();
            renderQuickProviders(top);

        } catch (e) {
            console.error("Error loading providers", e);
        }
    }

    function renderQuickProviders(topList) {
        const container = document.getElementById('quickProviders');
        container.innerHTML = '';
        if (topList.length === 0) {
            container.innerHTML = '<p class="text-xs text-slate-600 col-span-2">Sin historial a√∫n.</p>';
            return;
        }

        topList.forEach(p => {
            const div = document.createElement('div');
            div.className = "glass p-4 rounded-xl cursor-pointer hover:bg-slate-700 border border-slate-700 hover:border-blue-500 transition-all text-center";
            div.onclick = () => selectProvider(p);
            div.innerHTML = `<span class="font-bold text-white text-sm">${p.name}</span>`;
            container.appendChild(div);
        });
    }

    function filterProviders() {
        const input = document.getElementById('providerSearch');
        const filter = input.value.toLowerCase();
        const dropdown = document.getElementById('providerDropdown');

        dropdown.innerHTML = '';

        if (filter.length < 1) {
            dropdown.classList.add('hidden');
            return;
        }

        const filtered = providers.filter(p => p.name.toLowerCase().includes(filter));

        if (filtered.length > 0) {
            dropdown.classList.remove('hidden');
            filtered.forEach(p => {
                const div = document.createElement('div');
                div.className = "px-4 py-3 hover:bg-slate-700 cursor-pointer text-slate-200 border-b border-slate-700/50 last:border-0";
                div.textContent = p.name;
                div.onclick = () => selectProvider(p);
                dropdown.appendChild(div);
            });
        } else {
            dropdown.classList.add('hidden');
        }
    }

    function selectProvider(p) {
        selectedProvider = p;
        document.getElementById('providerSearch').value = p.name;
        document.getElementById('providerDropdown').classList.add('hidden');
        document.getElementById('nextBtn').disabled = false;
        document.getElementById('nextBtn').textContent = `Continuar con ${p.name}`;
    }

    function showCreateProvider() {
        document.getElementById('createModal').classList.remove('hidden');
        document.getElementById('newProviderName').focus();
    }

    function hideCreateProvider() {
        document.getElementById('createModal').classList.add('hidden');
    }

    async function saveProvider() {
        const name = document.getElementById('newProviderName').value;
        if (!name) return;

        try {
            const res = await fetch('/api/providers', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name })
            });
            const newProv = await res.json();

            // Refresh local list and select
            providers.push(newProv);
            selectProvider(newProv);
            hideCreateProvider();

        } catch (e) {
            alert("Error creating provider");
        }
    }

    function goToNextStep() {
        if (selectedProvider) {
            window.location.href = `/add-product?provider_id=${selectedProvider.id}&provider_name=${encodeURIComponent(selectedProvider.name)}`;
        }
    }

    // Init
    loadProviders();
</script>
{% endblock %}